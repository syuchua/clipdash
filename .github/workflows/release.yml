name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  linux-x86_64-gnu:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v4
      - name: Install GTK3 dev
        run: sudo apt-get update && sudo apt-get install -y libgtk-3-dev
      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: rel-linux-gnu-${{ hashFiles('**/Cargo.lock') }}
      - name: Build release
        run: |
          cargo build --release -p clipdash-daemon -p clipdash-cli
          cargo build --release -p clipdash-ui --features gtk-ui
      - name: Package tarball
        run: |
          bash scripts/package_release.sh linux-x86_64-gnu
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: clipdash-${{ github.ref_name }}-linux-x86_64-gnu
          path: dist/*.tar.gz
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  linux-x86_64-musl:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v4
      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: rel-linux-musl-${{ hashFiles('**/Cargo.lock') }}
      - name: Build static (CLI/Daemon)
        run: |
          sudo apt-get update && sudo apt-get install -y musl-tools
          RUSTFLAGS="-C target-feature=+crt-static" cargo build --release -p clipdash-daemon -p clipdash-cli --target x86_64-unknown-linux-musl
      - name: Package tarball
        run: |
          bash scripts/package_release.sh linux-x86_64-musl x86_64-unknown-linux-musl
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: clipdash-${{ github.ref_name }}-linux-x86_64-musl
          path: dist/*.tar.gz
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  linux-aarch64-gnu:
    runs-on: ubuntu-22.04-arm64
    steps:
      - uses: actions/checkout@v4
      - name: Install GTK3 dev
        run: sudo apt-get update && sudo apt-get install -y libgtk-3-dev
      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: rel-linux-arm64-gnu-${{ hashFiles('**/Cargo.lock') }}
      - name: Build release (ARM64 gnu)
        run: |
          cargo build --release -p clipdash-daemon -p clipdash-cli
          cargo build --release -p clipdash-ui --features gtk-ui
      - name: Package tarball
        run: |
          bash scripts/package_release.sh linux-aarch64-gnu
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: clipdash-${{ github.ref_name }}-linux-aarch64-gnu
          path: dist/*.tar.gz
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  linux-aarch64-musl:
    runs-on: ubuntu-22.04-arm64
    steps:
      - uses: actions/checkout@v4
      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-musl
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: rel-linux-arm64-musl-${{ hashFiles('**/Cargo.lock') }}
      - name: Build static (CLI/Daemon)
        run: |
          sudo apt-get update && sudo apt-get install -y musl-tools
          RUSTFLAGS="-C target-feature=+crt-static" cargo build --release -p clipdash-daemon -p clipdash-cli --target aarch64-unknown-linux-musl
      - name: Package tarball
        run: |
          bash scripts/package_release.sh linux-aarch64-musl aarch64-unknown-linux-musl
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: clipdash-${{ github.ref_name }}-linux-aarch64-musl
          path: dist/*.tar.gz
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
