name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  linux-x86_64-gnu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install GTK3 dev
        run: sudo apt-get update && sudo apt-get install -y libgtk-3-dev
      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: rel-linux-gnu-${{ hashFiles('**/Cargo.lock') }}
      - name: Build release
        run: |
          cargo build --release -p clipdash-daemon -p clipdash-cli
          cargo build --release -p clipdash-ui --features gtk-ui
      - name: cargo-deb packages (x86_64 gnu)
        run: |
          cargo install cargo-deb --version ^1.42 || true
          cargo deb -p clipdash-cli --no-strip --no-build
          cargo deb -p clipdash-daemon --no-strip --no-build
          # UI 已在上一步用 --features gtk-ui 构建过，这里仅打包，不再传递 features 参数
          cargo deb -p clipdash-ui --no-strip --no-build
          mkdir -p dist && cp -v target/debian/*.deb dist/
      - name: Package tarball
        run: |
          bash scripts/package_release.sh linux-x86_64-gnu
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: clipdash-${{ github.ref_name }}-linux-x86_64-gnu
          path: |
            dist/*.tar.gz
            dist/*.deb
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.tar.gz
            dist/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  linux-x86_64-musl:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: rel-linux-musl-${{ hashFiles('**/Cargo.lock') }}
      - name: Build static (CLI/Daemon)
        run: |
          sudo apt-get update && sudo apt-get install -y musl-tools
          RUSTFLAGS="-C target-feature=+crt-static" cargo build --release -p clipdash-daemon -p clipdash-cli --target x86_64-unknown-linux-musl
      - name: Package tarball
        run: |
          bash scripts/package_release.sh linux-x86_64-musl x86_64-unknown-linux-musl
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: clipdash-${{ github.ref_name }}-linux-x86_64-musl
          path: dist/*.tar.gz
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  linux-aarch64-gnu-cli:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install aarch64 cross toolchain
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu libc6-dev-arm64-cross
      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: rel-linux-arm64-gnu-${{ hashFiles('**/Cargo.lock') }}
      - name: Build release (ARM64 gnu, CLI/Daemon only)
        run: |
          cargo build --release -p clipdash-daemon -p clipdash-cli --target aarch64-unknown-linux-gnu
      - name: Package tarball
        run: |
          bash scripts/package_release.sh linux-aarch64-gnu aarch64-unknown-linux-gnu
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: clipdash-${{ github.ref_name }}-linux-aarch64-gnu
          path: dist/*.tar.gz
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # NOTE: aarch64 MUSL cross builds require zig/cross or extra toolchains; consider enabling later.
  # linux-aarch64-musl job disabled for now to avoid unavailable runner/toolchain issues.
