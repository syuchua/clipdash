# Clipdash 架构说明

目标：提供接近 Win+V 的一键呼出、快速搜索、即贴即用的 Linux 桌面剪贴板历史工具，轻量高性能、键盘优先、隐私可控。

## 1. 项目概览
- 名称：Clipdash
- 标语：一键呼出，快速搜索，即贴即用
- 形态：后台守护进程 + 弹出式前端 UI（GTK4）+ CLI + 托盘
- 开发方式：TDD（以契约与核心逻辑为先，端到端用例覆盖关键链路）

## 2. 核心功能（MVP）
- 历史记录：文本/图片/HTML 片段，去重、限长、TTL/敏感词过期
- 快速呼出：默认建议绑定为 Super+V（Win 键+V）
- 即时搜索：模糊匹配、最近优先、支持 Pin 常用项
- 预览与操作：回车粘贴、Shift+回车仅复制、Pin/删除/清空
- 托盘与设置：托盘菜单、开机自启、忽略应用/类型规则

## 3. 技术栈
- 语言：Rust（性能、内存安全、二进制小）
- UI：GTK4（gtk4-rs；Wayland/X11 兼容，依赖少）
- IPC：D-Bus（zbus）
- 剪贴板后端：
  - X11：x11rb + XFixes 监听 selection 事件 + 可选 XGrabKey 热键
  - Wayland：优先 xdg-desktop-portal；可选 wlroots `zwlr_data_control_v1`
  - 通过 `ClipboardBackend` trait 统一接口，按 feature 选择实现
- 存储：SQLite（rusqlite），最近 N 条缓存于内存以加速搜索
- 其他：serde（配置/数据序列化）、blake3（去重）、fuzzy-matcher（模糊搜索）、criterion（基准）

## 4. 总体架构

```
[GTK4 UI clipdash] -- D-Bus --> [clipdashd 守护]
     ^                                  |
     |<----- 信号广播（变更）-----------|
     |                                  v
 [系统托盘]                         [ClipboardBackend]
                                       |
                                [X11 | Wayland | Portal]
                                       |
                                   [SQLite 存储]
```

说明：
- UI 仅负责展示/交互，通过 D-Bus 查询/操作数据；守护进程负责监控剪贴板、存储、规则与清理。
- 前端订阅守护进程的变更信号以实现实时刷新。

## 5. 模块划分（建议 Rust Workspace）
- `clipdash-core`：领域模型（Item/Kind/Rule）、去重与 hash、搜索、配置（TOML）
- `clipdash-store`：SQLite DAO、迁移、压缩、导入导出
- `clipdash-backend`：`ClipboardBackend` trait + `x11`/`wayland`/`portal` 实现与模拟器
- `clipdash-daemon`：D-Bus 服务、规则调度、托盘、热键桥接
- `clipdash-ui`：GTK4 弹窗与视图状态机、键盘交互
- `clipdash-cli`：`popup/pin/delete/clear/config` 等命令

## 6. 数据模型
表：`items`
- `id` INTEGER PRIMARY KEY
- `kind` TEXT（Text|Image|Html）
- `data` BLOB/TEXT（小于阈值存内存，大于阈值落文件并存路径）
- `hash` TEXT（blake3(data+kind)）
- `pinned` INTEGER（0/1）
- `ts` INTEGER（Unix 毫秒时间戳）
- `source_app` TEXT（来源窗口类/进程名）
- `title` TEXT（列表展示用摘要/标题）

约束与规则：
- 最大条数（默认 200），文本最大长度（默认 100KB），图片最大大小（默认 2MB）
- 去重：相同 `hash` 的条目更新 `ts`（保持最近性）
- 隐私：忽略窗口类/进程名单（如 keepass/1password）；“隐私模式”仅缓存明示复制

## 7. IPC 设计（D-Bus）
接口：`org.clipdash.Daemon`
- 方法：
  - `List(limit:u32, query:Option<String>) -> Vec<ItemDto>`
  - `Get(id:u64) -> ItemDto`
  - `Paste(id:u64) -> ()`
  - `Pin(id:u64, pinned:bool) -> ()`
  - `Delete(id:u64) -> ()`
  - `Clear() -> ()`
  - `ConfigGet() -> ConfigDto`
  - `ConfigSet(ConfigDto) -> ()`
- 信号：
  - `ClipboardChanged(item: ItemDto)`
  - `ItemUpdated(id:u64)`
  - `HistoryCleared()`

错误：
- `NotFound`、`InvalidArgument`、`BackendUnavailable`、`PermissionDenied`

## 8. 剪贴板后端契约

```rust
pub enum ClipKind { Text, Image, Html }

pub struct ClipData {
    pub kind: ClipKind,
    pub bytes: Vec<u8>,
    pub mime: Option<String>,
}

pub trait ClipboardBackend: Send + Sync {
    /// 订阅剪贴板变化（去抖动后发射新数据）
    fn subscribe(&self, cb: impl Fn(ClipData) + Send + 'static);
    /// 读取当前剪贴板内容
    fn read_current(&self) -> Option<ClipData>;
    /// 将指定数据写入系统剪贴板
    fn write(&self, data: &ClipData) -> Result<(), BackendError>;
}
```

实现：
- X11：基于 XFixes 监听 SelectionNotify；粘贴时按 target 选择（UTF8_STRING / image mime）
- Wayland：优先 xdg-desktop-portal；必要时 wlroots data-control（可配置）

## 9. 热键策略
- Wayland：全局热键依赖 xdg-desktop-portal Global Shortcuts；否则引导用户在 DE 中将 `Super+V` 绑定到 `clipdash popup`
- X11：可选择内置 XGrabKey（默认关闭，避免冲突；失败则提示用户手动绑定）

## 10. 配置
- 路径：`~/.config/clipdash/config.toml`
- 关键项：
  - `max_items = 200`
  - `max_text_bytes = 100_000`
  - `max_image_bytes = 2_000_000`
  - `ttl_hours = 168`（0 表示永不过期）
  - `ignore_sources = ["keepass", "1password"]`
  - `backend = "portal" | "x11" | "wayland"`
  - `hotkey = "<Super>V"`（当走 portal/DE 绑定时仅用于提示）

## 11. 性能目标
- 守护进程常驻内存 < 25 MB；UI 弹窗 < 30 MB
- UI 冷启动 < 80 ms（预取最近 N=120 条入内存）
- 搜索 < 10 ms（模糊匹配）
- 写放大控制：批量提交/延迟 fsync；定期 VACUUM/压缩
- 二进制体积 < 10 MB（strip + LTO）

## 12. TDD 开发计划与关键用例
- 核心与存储
  - `core_ring_buffer_keeps_pinned_on_trim`
  - `store_roundtrip_preserves_item_ordering`
- 搜索与规则
  - `search_fuzzy_matches_rank_recent_higher`
  - `rules_prunes_by_ttl_and_ignores_sources`
- 后端与契约
  - `backend_contract_emits_change_on_new_selection`
- IPC
  - `dbus_list_and_get_are_consistent`
- UI 状态机
  - `ui_state_enter_leave_keystrokes_are_idempotent`

## 13. CLI 与服务
- 命令：
  - `clipdash daemon`：启动守护（建议 systemd --user 管理）
  - `clipdash popup`：呼出 UI（供 DE 绑定快捷键）
  - `clipdash list|get|pin|delete|clear|config`：脚本/自动化
- systemd --user 单元示例：

```ini
[Unit]
Description=Clipdash Daemon

[Service]
ExecStart=%h/.local/bin/clipdash daemon
Restart=on-failure

[Install]
WantedBy=default.target
```

## 14. 目录建议（后续实现时）

```
clipdash/
├─ crates/
│  ├─ core/
│  ├─ store/
│  ├─ backend/
│  ├─ daemon/
│  ├─ ui/
│  └─ cli/
├─ Cargo.toml            # workspace
├─ README.md             # 使用说明与截图
└─ 架构.md               # 本文件
```

## 15. 风险与降级
- Wayland 权限差异：多后端并存 + Portal 优先 + 清晰降级指引
- 全局热键冲突：探测失败 → 提示用户在 DE 绑定命令
- 隐私：默认忽略常见密码管理器；一键“隐私模式”，只临时缓存

## 16. 里程碑（MVP → 完整版）
1) 核心/存储/后端 mock + D-Bus + CLI（无 UI）
2) GTK4 弹窗（列表+搜索+粘贴）+ X11/Portal 基础后端
3) 托盘、自启动、Pin/删除、配置
4) Wayland/wlroots 扩展、图片/HTML 预览、性能收尾

---
本文档作为统一的架构与约束来源，TDD 用例名称与接口契约应与本文保持一致，变更需同步更新。
